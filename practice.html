<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fraction Assessment</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2em;
        }
        
        h2 {
            text-align: center;
            color: #2c3e50;
            margin-top: 10px;
            font-size: 1.5em;
        }

        .instruction {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .visualization {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            margin-bottom: 50px;
            flex-wrap: wrap;
            position: relative;
        }
        
        .pizza-container {
            position: relative;
            padding: 20px;
            border-radius: 15px;
            min-width: 180px;
            transition: box-shadow 0.3s, border 0.3s;
            border: 2px dashed transparent;
        }

        .pizza {
            width: 150px;
            height: 150px;
            position: relative;
        }
        .fraction-label {
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            margin-top: 10px;
            color: #2c3e50;
        }
        .operator {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
        }
        svg {
            width: 100%;
            height: 100%;
        }
        .slice {
            cursor: grab;
            transition: opacity 0.3s;
        }
        .slice:hover {
            opacity: 0.8;
            filter: brightness(1.1);
        }
        
        .slice.dragging {
            visibility: hidden;
        }
        
        .drop-target {
            box-shadow: 0 0 20px 5px rgba(66, 165, 245, 0.7);
            border: 2px dashed #42a5f5;
        }
        
        /* --- UPDATED RULE --- */
        .floating-slice {
            position: fixed; /* Changed to fixed for smoother scrolling behavior */
            width: 150px;
            height: 150px;
            pointer-events: none; /* Allows elements below to be detected */
            z-index: 1000;
            transform: scale(1.1);
            filter: drop-shadow(0 10px 8px rgba(0,0,0,0.2));
            transition: transform 0.2s;
        }

        /* --- SUBTRACTION CHANGE: Styles to hide elements during subtraction mode --- */
        .subtraction-mode .operator-equals,
        .subtraction-mode .pizza-container[data-pizza="pizza3"] {
            display: none;
        }

        .quiz-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-top: 40px;
        }
        .quiz-title {
            text-align: center;
            font-size: 1.5em;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        .equation {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            font-size: 1.8em;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .fraction-input {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .fraction-input input {
            width: 80px;
            height: 50px;
            text-align: center;
            font-size: 1.2em;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 5px;
        }
        .fraction-input .line {
            width: 80px;
            height: 2px;
            background: #333;
        }
        .buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        button {
            padding: 12px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-hint {
            background: #ffa726;
            color: white;
        }
        .btn-hint:hover {
            background: #fb8c00;
            transform: translateY(-2px);
        }
        .btn-check {
            background: #42a5f5;
            color: white;
        }
        .btn-check:hover {
            background: #1e88e5;
            transform: translateY(-2px);
        }
        .feedback {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
        }
        .feedback.correct {
            color: #4caf50;
            background: #e8f5e9;
        }
        .feedback.incorrect {
            color: #f44336;
            background: #ffebee;
        }
        .question-info {
            text-align: center;
            color: #666;
            margin-top: 20px;
        }
        .completion-screen {
            display: none;
            text-align: center;
            padding: 40px;
        }
        .completion-screen.active {
            display: block;
        }
        .completion-screen h2 {
            color: #4caf50;
            font-synthesis: 2.5em;
            margin-bottom: 20px;
        }
        .completion-screen p {
            color: #666;
            font-size: 1.3em;
            margin-bottom: 30px;
        }
        .score {
            font-size: 3em;
            color: #2c3e50;
            font-weight: bold;
            margin: 20px 0;
        }
        .btn-restart {
            background: #9c27b0;
            color: white;
        }
        .btn-restart:hover {
            background: #7b1fa2;
            transform: translateY(-2px);
        }
        
        .hide {
            display: none;
        }
        .slider-container {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 20px;
        }
        .slider-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .slider-group span {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .slider-group input[type="range"] {
            -webkit-appearance: none;
            width: 200px;
            height: 10px;
            background: #d3d3d3;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
            border-radius: 5px;
        }
        .slider-group input[type="range"]:hover {
            opacity: 1;
        }
        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            background: #4caf50;
            cursor: pointer;
            border-radius: 50%;
        }
        .slider-group input[type="range"]::-moz-range-thumb {
            width: 25px;
            height: 25px;
            background: #4caf50;
            cursor: pointer;
            border-radius: 50%;
        }
        
        .start-button {
            padding: 15px 40px;
            font-size: 1.2em;
            font-weight: bold;
            color: white;
            background: #4CAF50;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            margin-top: 30px;
            transition: background 0.3s;
        }
        .start-button:hover {
            background: #45a049;
        }
        
        /* New styles for initial visualizer */
        .initial-visualizer {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            text-align: center;
        }
        .initial-visualizer .pizza-container {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Fractions Assessment</h1>
        <p class="instruction">This module helps you understand and practice basic fraction operations.</p>
        
        <div id="initial-page" class="initial-visualizer">
            <h2>What is a Fraction?</h2>
            <p>A fraction represents a part of a whole. The top number is the <b>numerator</b>, which tells us how many parts we have. The bottom number is the <b>denominator</b>, which tells us how many total parts the whole is divided into.</p>
            <div class="pizza-container">
                <svg class="pizza" id="pizza-init" viewBox="0 0 100 100"></svg>
                <div class="fraction-label" id="label-init">1/4</div>
            </div>
            
            <div class="slider-container">
                <div class="slider-group">
                    <span>Numerator:</span>
                    <input type="range" id="numerator-slider" min="0" max="10" value="1">
                </div>
                <div class="slider-group">
                    <span>Denominator:</span>
                    <input type="range" id="denominator-slider" min="1" max="10" value="4">
                </div>
            </div>
            
            <button class="start-button" onclick="startQuiz()">Start Quiz ►</button>
        </div>

        <div id="quiz-content" class="hide">
            <div class="quiz-section">
                <h2 class="quiz-title">Fraction <span id="operation-type">Addition</span> Quiz</h2>
                <p class="instruction" id="instruction">Click the button below to start dragging slices!</p>
                <div class="visualization" id="visualization">
                    <div class="pizza-container" data-pizza="pizza1">
                        <svg class="pizza" id="pizza1" viewBox="0 0 100 100"></svg>
                        <div class="fraction-label" id="label1">0/3</div>
                    </div>
                    <div class="operator" id="operator">+</div>
                    <div class="pizza-container" data-pizza="pizza2">
                        <svg class="pizza" id="pizza2" viewBox="0 0 100 100"></svg>
                        <div class="fraction-label" id="label2">0/3</div>
                    </div>
                    <div class="operator operator-equals">=</div>
                    <div class="pizza-container" data-pizza="pizza3">
                        <svg class="pizza" id="pizza3" viewBox="0 0 100 100"></svg>
                        <div class="fraction-label" id="label3">0/3</div>
                    </div>
                </div>
                
                <div class="equation">
                    <div class="fraction-input">
                        <div id="num1">2</div>
                        <div class="line"></div>
                        <div id="den1">3</div>
                    </div>
                    <div id="quiz-operator">+</div>
                    <div class="fraction-input">
                        <div id="num2">1</div>
                        <div class="line"></div>
                        <div id="den2">3</div>
                    </div>
                    <div>=</div>
                    <div class="fraction-input">
                        <input type="number" id="answer-num" placeholder="?" min="0" max="10">
                        <div class="line"></div>
                        <input type="number" id="answer-den" placeholder="?" min="1" max="10">
                    </div>
                </div>
                <div class="buttons">
                    <button class="btn-hint" onclick="showHint()">Get Hint</button>
                    <button class="btn-check" onclick="checkAnswer()">✓ Check Answer</button>
                </div>
                <div class="feedback" id="feedback"></div>
                <div class="question-info" id="question-info">Question 1 of 6</div>
            </div>
        </div>
        
        <div class="completion-screen" id="completion-screen">
            <h2>🎉 Congratulations! 🎉</h2>
            <p>You've completed the module!</p>
            <div class="score">
                <span id="final-score">Score: 0/0</span>
            </div>
            <p>Great job learning about fractions!</p>
            <button class="btn-restart" onclick="restartQuiz()">Start Over</button>
        </div>
        
        <div class="hide" id="mode-completion-screen">
            <h2 style="color:#2c3e50; text-align: center; margin-top: 40px;">Great job with Addition!</h2>
            <p class="instruction">Ready to try Subtraction?</p>
            <div style="text-align: center;">
                <button class="start-button" onclick="startSubtractionQuiz()">Start Subtraction Quiz ►</button>
            </div>
        </div>
    </div>
    
    <script>
    // --------------- state ----------------
    let currentMode = 'addition';
    let draggingEnabled = false;
    let slices = { pizza1: 0, pizza2: 0, pizza3: 0 };
    let totalSlices = 4;
    let draggedSlice = null;
    let floatingSlice = null;
    let originalPizza = null;
    let sliceIndex = null;
    let currentQuestion = 0;
    let correctAnswers = 0;
    
    const additionQuestions = [
        { num1: 2, den1: 3, num2: 1, den2: 3, answer_num: 3, answer_den: 3, slices1: 2, slices2: 1, totalSlices: 3 },
        { num1: 1, den1: 4, num2: 2, den2: 4, answer_num: 3, answer_den: 4, slices1: 1, slices2: 2, totalSlices: 4 },
        { num1: 1, den1: 3, num2: 1, den2: 3, answer_num: 2, answer_den: 3, slices1: 1, slices2: 1, totalSlices: 3 },
    ];
    
    const subtractionQuestions = [
        { num1: 3, den1: 4, num2: 1, den2: 4, answer_num: 2, answer_den: 4, slices1: 3, slices2: 1, totalSlices: 4 },
        { num1: 2, den1: 3, num2: 1, den2: 3, answer_num: 1, answer_den: 3, slices1: 2, slices2: 1, totalSlices: 3 },
        { num1: 5, den1: 6, num2: 2, den2: 6, answer_num: 3, answer_den: 6, slices1: 5, slices2: 2, totalSlices: 6 },
    ];
    
    let currentQuizQuestions = additionQuestions;
    
    // Initial visualizer logic
    const initNumeratorSlider = document.getElementById('numerator-slider');
    const initDenominatorSlider = document.getElementById('denominator-slider');
    const initLabel = document.getElementById('label-init');
    const initPizzaSvg = document.getElementById('pizza-init');
    
    initNumeratorSlider.addEventListener('input', updateInitialVisualizer);
    initDenominatorSlider.addEventListener('input', updateInitialVisualizer);
    
    function updateInitialVisualizer() {
        let num = parseInt(initNumeratorSlider.value, 10);
        let den = parseInt(initDenominatorSlider.value, 10);
        
        if (num > den) {
            num = den;
            initNumeratorSlider.value = den;
        }
        
        initLabel.textContent = `${num}/${den}`;
        
        createPizza(initPizzaSvg, num, den);
    }
    
    function createPizza(svg, filledSlices, totalSlices) {
        svg.innerHTML = '';
        
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', '50');
        circle.setAttribute('cy', '50');
        circle.setAttribute('r', '45');
        circle.setAttribute('fill', 'white');
        circle.setAttribute('stroke', '#666');
        circle.setAttribute('stroke-width', '2');
        svg.appendChild(circle);

        for (let i = 0; i < totalSlices; i++) {
            const angle = (360 / totalSlices) * i;
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', '50');
            line.setAttribute('y1', '50');
            line.setAttribute('x2', 50 + 45 * Math.cos((angle - 90) * Math.PI / 180));
            line.setAttribute('y2', 50 + 45 * Math.sin((angle - 90) * Math.PI / 180));
            line.setAttribute('stroke', '#666');
            line.setAttribute('stroke-width', '2');
            svg.appendChild(line);
        }

        for (let i = 0; i < filledSlices; i++) {
            const startAngle = (360 / totalSlices) * i - 90;
            const endAngle = (360 / totalSlices) * (i + 1) - 90;
            const x1 = 50 + 45 * Math.cos(startAngle * Math.PI / 180);
            const y1 = 50 + 45 * Math.sin(startAngle * Math.PI / 180);
            const x2 = 50 + 45 * Math.cos(endAngle * Math.PI / 180);
            const y2 = 50 + 45 * Math.sin(endAngle * Math.PI / 180);
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const d = `M 50 50 L ${x1} ${y1} A 45 45 0 0 1 ${x2} ${y2} Z`;
            path.setAttribute('d', d);
            path.setAttribute('fill', '#42a5f5');
            path.setAttribute('stroke', '#666');
            path.setAttribute('stroke-width', '2');
            path.classList.add('slice');
            svg.appendChild(path);
        }
    }
    
    function startQuiz() {
        document.getElementById('initial-page').classList.add('hide');
        document.getElementById('quiz-content').classList.remove('hide');
        loadQuestion();
    }
    
    function startSubtractionQuiz() {
        document.getElementById('mode-completion-screen').classList.add('hide');
        document.getElementById('quiz-content').classList.remove('hide');
        currentMode = 'subtraction';
        currentQuizQuestions = subtractionQuestions;
        currentQuestion = 0;
        loadQuestion();
    }
    
    function loadQuestion() {
        if (currentQuestion >= currentQuizQuestions.length) {
            if (currentMode === 'addition') {
                showModeCompletion();
            } else {
                showCompletionScreen();
            }
            return;
        }
        
        const q = currentQuizQuestions[currentQuestion];
        totalSlices = q.totalSlices;
        const viz = document.getElementById('visualization');
        
        document.getElementById('operation-type').textContent = currentMode.charAt(0).toUpperCase() + currentMode.slice(1);
        
        if (currentMode === 'addition') {
            viz.classList.remove('subtraction-mode');
            document.getElementById('operator').textContent = '+';
            document.getElementById('quiz-operator').textContent = '+';
            document.getElementById('instruction').textContent = 'Drag the slices from the first two pizzas to the empty one!';
            slices = { pizza1: q.slices1, pizza2: q.slices2, pizza3: 0 };
        } else { // Subtraction mode
            viz.classList.add('subtraction-mode');
            document.getElementById('operator').textContent = '-';
            document.getElementById('quiz-operator').textContent = '-';
            document.getElementById('instruction').textContent = 'Drag the red slices from the second pizza onto the blue slices to subtract!';
            slices = { pizza1: q.slices1, pizza2: q.slices2, pizza3: 0 };
        }
        
        document.getElementById('num1').textContent = q.num1;
        document.getElementById('den1').textContent = q.den1;
        document.getElementById('num2').textContent = q.num2;
        document.getElementById('den2').textContent = q.den2;
        
        document.getElementById('answer-num').value = '';
        document.getElementById('answer-den').value = '';
        const fb = document.getElementById('feedback');
        fb.textContent = '';
        fb.className = 'feedback';
        
        const totalQuestions = additionQuestions.length + subtractionQuestions.length;
        const currentGlobalQuestion = (currentMode === 'addition' ? 0 : additionQuestions.length) + currentQuestion + 1;
        document.getElementById('question-info').textContent = `Question ${currentGlobalQuestion} of ${totalQuestions}`;
        
        draggingEnabled = true;
        updateVisualization();
    }
    
    function createQuizPizza(svgId, filledSlices = 0, color = '#42a5f5') {
        const svg = document.getElementById(svgId);
        svg.innerHTML = '';
        
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', '50');
        circle.setAttribute('cy', '50');
        circle.setAttribute('r', '45');
        circle.setAttribute('fill', 'white');
        circle.setAttribute('stroke', '#ccc');
        circle.setAttribute('stroke-width', '1');
        svg.appendChild(circle);
        
        for (let i = 0; i < totalSlices; i++) {
            const angle = (360 / totalSlices) * i;
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', '50');
            line.setAttribute('y1', '50');
            line.setAttribute('x2', 50 + 45 * Math.cos((angle - 90) * Math.PI / 180));
            line.setAttribute('y2', 50 + 45 * Math.sin((angle - 90) * Math.PI / 180));
            line.setAttribute('stroke', '#ccc');
            line.setAttribute('stroke-width', '1');
            svg.appendChild(line);
        }
        
        for (let i = 0; i < filledSlices; i++) {
            addSlice(svg, i, color, svgId);
        }
    }
    
    function addSlice(svg, index, color, pizzaId) {
        const startAngle = (360 / totalSlices) * index - 90;
        const endAngle = (360 / totalSlices) * (index + 1) - 90;
        
        const x1 = 50 + 45 * Math.cos(startAngle * Math.PI / 180);
        const y1 = 50 + 45 * Math.sin(startAngle * Math.PI / 180);
        const x2 = 50 + 45 * Math.cos(endAngle * Math.PI / 180);
        const y2 = 50 + 45 * Math.sin(endAngle * Math.PI / 180);
        
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        const d = `M 50 50 L ${x1} ${y1} A 45 45 0 0 1 ${x2} ${y2} Z`;
        path.setAttribute('d', d);
        path.setAttribute('fill', color);
        path.setAttribute('stroke', '#666');
        path.setAttribute('stroke-width', '2');
        path.classList.add('slice');
        path.dataset.pizzaId = pizzaId;
        path.dataset.sliceIndex = index;
        
        let isDraggable = false;
        if (currentMode === 'addition' && (pizzaId === 'pizza1' || pizzaId === 'pizza2')) {
            isDraggable = true;
        } else if (currentMode === 'subtraction' && pizzaId === 'pizza2') {
            isDraggable = true;
        }

        if (draggingEnabled && isDraggable) {
            path.style.cursor = 'grab';
            path.addEventListener('mousedown', startDrag);
            path.addEventListener('touchstart', startDrag, { passive: false });
        }
        
        svg.appendChild(path);
    }
    
    function createFloatingSlice(color, startAngle, endAngle) {
        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.classList.add('floating-slice');
        svg.setAttribute('viewBox', '0 0 100 100');
        
        const x1 = 50 + 45 * Math.cos(startAngle * Math.PI / 180);
        const y1 = 50 + 45 * Math.sin(startAngle * Math.PI / 180);
        const x2 = 50 + 45 * Math.cos(endAngle * Math.PI / 180);
        const y2 = 50 + 45 * Math.sin(endAngle * Math.PI / 180);
        
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        const d = `M 50 50 L ${x1} ${y1} A 45 45 0 0 1 ${x2} ${y2} Z`;
        path.setAttribute('d', d);
        path.setAttribute('fill', color);
        path.setAttribute('stroke', '#333');
        path.setAttribute('stroke-width', '3');
        
        svg.appendChild(path);
        return svg;
    }
    
    function startDrag(e) {
        if (!draggingEnabled) return;
        e.preventDefault();
        
        draggedSlice = e.currentTarget || e.target;
        originalPizza = draggedSlice.dataset.pizzaId;
        sliceIndex = parseInt(draggedSlice.dataset.sliceIndex, 10);
        
        if (!slices[originalPizza] || slices[originalPizza] <= 0) {
             draggedSlice = null;
             return;
        }
        
        draggedSlice.classList.add('dragging');
        
        const startAngle = (360 / totalSlices) * sliceIndex - 90;
        const endAngle = (360 / totalSlices) * (sliceIndex + 1) - 90;
        const color = draggedSlice.getAttribute('fill');
        
        floatingSlice = createFloatingSlice(color, startAngle, endAngle);
        document.body.appendChild(floatingSlice);
        
        const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
        const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
        
        floatingSlice.style.left = (clientX - 75) + 'px';
        floatingSlice.style.top = (clientY - 75) + 'px';
        
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchmove', drag, { passive: false });
        document.addEventListener('touchend', endDrag);
    }
    
    function drag(e) {
        if (!floatingSlice) return;
        
        const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
        const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
        
        floatingSlice.style.left = (clientX - 75) + 'px';
        floatingSlice.style.top = (clientY - 75) + 'px';
        
        document.querySelectorAll('.pizza-container').forEach(container => {
            container.classList.remove('drop-target');
        });
        
        const elementBelow = document.elementFromPoint(clientX, clientY);
        const pizzaContainer = elementBelow?.closest('.pizza-container');
        
        const dropTargetPizzaId = currentMode === 'addition' ? 'pizza3' : 'pizza1';
        if (pizzaContainer && pizzaContainer.dataset.pizza === dropTargetPizzaId) {
            pizzaContainer.classList.add('drop-target');
        }
    }
    
    function endDrag(e) {
        if (!floatingSlice) return;
        
        const clientX = e.type === 'touchend' ? e.changedTouches[0].clientX : e.clientX;
        const clientY = e.type === 'touchend' ? e.changedTouches[0].clientY : e.clientY;
        
        const elementBelow = document.elementFromPoint(clientX, clientY);
        const pizzaContainer = elementBelow?.closest('.pizza-container');
        
        document.querySelectorAll('.pizza-container').forEach(container => {
            container.classList.remove('drop-target');
        });
        
        const dropTargetPizzaId = currentMode === 'addition' ? 'pizza3' : 'pizza1';
        if (pizzaContainer && pizzaContainer.dataset.pizza === dropTargetPizzaId) {
            if (currentMode === 'addition') {
                if ((originalPizza === 'pizza1' || originalPizza === 'pizza2') && slices[originalPizza] > 0) {
                    slices[originalPizza]--;
                    slices.pizza3++;
                }
            } else { // Subtraction
                if (originalPizza === 'pizza2' && slices.pizza2 > 0) {
                    slices.pizza2--;
                    slices.pizza1--; // This makes a blue slice disappear
                }
            }
            updateVisualization();
        } else {
             if (draggedSlice) draggedSlice.classList.remove('dragging');
        }
        
        if (floatingSlice) floatingSlice.remove();
        floatingSlice = null;
        draggedSlice = null;
        
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('mouseup', endDrag);
        document.removeEventListener('touchmove', drag);
        document.removeEventListener('touchend', endDrag);
    }
    
    function updateVisualization() {
        if (currentMode === 'subtraction') {
            createQuizPizza('pizza1', slices.pizza1, '#42a5f5');
            createQuizPizza('pizza2', slices.pizza2, '#ef5350');

            document.getElementById('label1').textContent = `${slices.pizza1}/${totalSlices}`;
            document.getElementById('label2').textContent = `${slices.pizza2}/${totalSlices}`;

            if (slices.pizza2 === 0) {
                document.getElementById('instruction').textContent = "Great! You've subtracted all the slices. Now answer the quiz below.";
            }

        } else { // Addition mode (original logic)
            createQuizPizza('pizza1', slices.pizza1, '#42a5f5');
            createQuizPizza('pizza2', slices.pizza2, '#42a5f5');
            createQuizPizza('pizza3', slices.pizza3, '#ef5350');
            
            document.getElementById('label1').textContent = `${slices.pizza1}/${totalSlices}`;
            document.getElementById('label2').textContent = `${slices.pizza2}/${totalSlices}`;
            document.getElementById('label3').textContent = `${slices.pizza3}/${totalSlices}`;

            if (slices.pizza3 === currentQuizQuestions[currentQuestion].answer_num) {
                document.getElementById('instruction').textContent = "Great! You've combined the slices. Now answer the quiz below.";
            }
        }
    }
    
    function showHint() {
        const feedback = document.getElementById('feedback');
        feedback.className = 'feedback';
        feedback.style.color = '#1976d2';
        feedback.style.background = '#e3f2fd';
        if (currentMode === 'addition') {
            feedback.textContent = 'Hint: To add fractions with the same denominator, add the numerators together and keep the denominator the same.';
        } else {
            feedback.textContent = 'Hint: To subtract fractions with the same denominator, subtract the second numerator from the first and keep the denominator the same.';
        }
    }
    
    function goToNextQuestion() {
        currentQuestion++;
        loadQuestion();
    }
    
    function checkAnswer() {
        const numAnswer = parseInt(document.getElementById('answer-num').value, 10);
        const denAnswer = parseInt(document.getElementById('answer-den').value, 10);
        const feedback = document.getElementById('feedback');
        
        const q = currentQuizQuestions[currentQuestion];
        
        if (numAnswer === q.answer_num && denAnswer === q.answer_den) {
            feedback.textContent = 'Correct! ✓';
            feedback.className = 'feedback correct';
            correctAnswers++;
            
            setTimeout(() => {
                goToNextQuestion();
            }, 1000);
        } else {
            feedback.textContent = 'Not quite! Try using the drag-and-drop visual to find the answer.';
            feedback.className = 'feedback incorrect';
        }
    }
    
    function showModeCompletion() {
        document.getElementById('quiz-content').classList.add('hide');
        document.getElementById('mode-completion-screen').classList.remove('hide');
    }
    
    function showCompletionScreen() {
        document.getElementById('quiz-content').classList.add('hide');
        const completionScreen = document.getElementById('completion-screen');
        completionScreen.classList.remove('hide');
        completionScreen.classList.add('active');
        
        const totalQuestions = additionQuestions.length + subtractionQuestions.length;
        const finalScoreEl = document.getElementById('final-score');
        finalScoreEl.textContent = `Score: ${correctAnswers}/${totalQuestions}`;
    }
    
    function restartQuiz() {
        document.getElementById('completion-screen').classList.add('hide', 'active');
        document.getElementById('initial-page').classList.remove('hide');
        
        currentMode = 'addition';
        currentQuizQuestions = additionQuestions;
        currentQuestion = 0;
        correctAnswers = 0;
        
        updateInitialVisualizer();
    }
    
    // Initial call to set up the page
    updateInitialVisualizer();
</script>
</body>
</html>